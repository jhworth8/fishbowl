<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pixel Fish Aquarium Idle - Enhanced Edition</title>

  <!-- Pixel Font: Press Start 2P -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- jQuery (for event handling & DOM manipulation) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Bootstrap CSS for modals and layout -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    /********************************************************
     *********************** PIXEL THEME ********************
     ********************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      image-rendering: pixelated; /* Ensures images/text remain sharp */
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Press Start 2P', sans-serif; /* pixelated font */
      overflow: hidden;
      position: relative;
      /* Subtle gradient behind the aquarium. */
      background: linear-gradient(to bottom right, #1e3d59, #2a5273);
    }

    /********************************************************
     *********************** TOP BAR ************************
     ********************************************************/
    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 999;
    }
    .top-bar > div {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px 15px;
      border-radius: 5px;
      margin: 0 4px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    .top-bar > div:hover {
      background-color: rgba(255, 255, 255, 1);
    }
    .coin-display {
      pointer-events: none;
    }

    /********************************************************
     ********************** AQUARIUM ************************
     ********************************************************/
    #aquarium {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      /* Optionally use a pixel-art aquarium background image: */
      background-image: url('aquarium_bg.png');
      background-size: cover;
      background-position: center;
    }

    /********************************************************
     *********************** FISH ***************************
     ********************************************************/
    .fish {
      position: absolute;
      background-size: contain;
      background-repeat: no-repeat;
      transform-origin: center;
      transition: transform 0.3s, left 0.3s linear, top 0.3s linear;
      width: 48px;
      height: 32px;
    }

    /********************************************************
     *********************** FOOD ****************************
     ********************************************************/
    .food {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      z-index: 500;
    }

    /********************************************************
     ********************* BUBBLES **************************
     ********************************************************/
    .bubble {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: bubble-rise 5s linear infinite;
      pointer-events: none;
      opacity: 0.7;
    }
    @keyframes bubble-rise {
      0%   { transform: translateY(0) scale(1); opacity: 0.7; }
      50%  { transform: translateY(-150px) scale(1.2); }
      100% { transform: translateY(-300px) scale(1); opacity: 0; }
    }

    /********************************************************
     ****************** FLOATING TEXT ***********************
     ********************************************************/
    .floating-text {
      position: absolute;
      color: #fff;
      font-size: 12px;
      pointer-events: none;
      animation: floatUp 2s ease-out forwards;
      text-shadow: 1px 1px 2px #000;
    }
    @keyframes floatUp {
      0%   { opacity: 1;   transform: translateY(0); }
      100% { opacity: 0;   transform: translateY(-50px); }
    }

    /********************************************************
     ********************* MODAL STYLES *********************
     ********************************************************/
    .modal-overlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      max-height: 85%;
      overflow-y: auto;
      animation: fadeIn 0.4s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      font-size: 14px;
    }
    .close-modal {
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }
    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #ccc;
    }
    .item-row img {
      width: 40px;
      height: 32px;
    }
    .item-row button {
      padding: 6px 12px;
      background-color: #1e90ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .item-row button:hover {
      background-color: #3742fa;
    }
    /* Hover tooltip for fish stats in store */
    .fish-tooltip {
      font-size: 10px;
      color: #000;
      background-color: #ffc;
      border: 1px solid #999;
      padding: 4px;
      border-radius: 4px;
      position: absolute;
      z-index: 3000;
      display: none;
      pointer-events: none;
    }

    /********************************************************
     ************** ACHIEVEMENTS BUTTON BADGE ***************
     ********************************************************/
    .achievements-button {
      position: relative;
    }
    .achievements-button::after {
      content: attr(data-badge);
      position: absolute;
      top: -5px; 
      right: -10px;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 10px;
      display: none;
    }
    .has-new-achievements.achievements-button::after {
      display: block;
    }

    /********************************************************
     ******************* RESPONSIVE DESIGN ******************
     ********************************************************/
    @media (max-width: 768px) {
      .fish { width: 36px; height: 24px; }
      .food { width: 12px; height: 12px; }
      .item-row img { width: 30px; height: 24px; }
      .item-row button {
        padding: 4px 8px;
        font-size: 10px;
      }
      .floating-text {
        font-size: 10px;
      }
      .fish-tooltip {
        font-size: 8px;
        padding: 3px;
      }
    }
  </style>
</head>

<body>
  <!-- ================== TOP BAR ================== -->
  <div class="top-bar">
    <div class="store-button">Store</div>
    <div class="upgrades-button">Global Upgrades</div>
    <div class="expansions-button">Expansions</div>
    <div class="achievements-button" data-badge="0">Achievements</div>
    <div class="reset-button">Reset All</div>
    <div class="coin-display">Coins: <span id="coin-count">0</span></div>
  </div>

  <!-- ================== AQUARIUM ================== -->
  <div id="aquarium"></div>

  <!-- ================== MODALS ================== -->
  <!-- Store Modal -->
  <div class="modal-overlay store-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Fish Store</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div id="store-items"></div>
    </div>
  </div>

  <!-- Upgrades Modal -->
  <div class="modal-overlay upgrades-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Global Upgrades</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div id="upgrade-items"></div>
    </div>
  </div>

  <!-- Expansions Modal -->
  <div class="modal-overlay expansions-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Expansions</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div id="expansion-items"></div>
    </div>
  </div>

  <!-- Achievements Modal -->
  <div class="modal-overlay achievements-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Achievements</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div id="achievement-items"></div>
    </div>
  </div>

  <!-- Optional Sound Effects -->
  <!--
    <audio id="sound-eat" src="eat_sound.mp3"></audio>
    <audio id="sound-buy" src="buy_sound.mp3"></audio>
    <audio id="sound-reset" src="reset_sound.mp3"></audio>
    <audio id="bg-music" src="bg_music.mp3" loop></audio>
  -->

  <!-- Tooltip for fish stats on hover -->
  <div class="fish-tooltip" id="fish-tooltip"></div>

  <script>
    /*******************************************************
     *********************** ON READY ***********************
     *******************************************************/
    $(document).ready(() => {
      /*
        ======================================================
        ===================== GAME DATA ======================
        ======================================================
      */

      let coins = 0;

      // Constants
      const STALE_ASSIGNMENT_LIMIT = 7; // seconds
      const COIN_SPAWN_MARGIN = 40; // px

      // FISH DEFINITIONS
      const fishTypes = [];
      for (let i = 1; i <= 10; i++) {
        fishTypes.push({
          id: i,
          name: "Fish " + i,
          cost: 50 * i,
          baseEarning: i,             // base coins per food eaten
          baseSpeed: 1.5 + i * 0.15,  // base speed
          image: `fish_${i}.png`,
          // The fish-specific upgrades stored here:
          upgrades: [
            {
              id: `speed-${i}`,
              name: `Speed +1 for Fish ${i}`,
              description: `Increase speed by 1`,
              cost: 200 * i,
              purchasedCount: 0
            },
            {
              id: `earning-${i}`,
              name: `Earning +1 for Fish ${i}`,
              description: `Increase earning by 1 coin per food`,
              cost: 300 * i,
              purchasedCount: 0
            }
          ]
        });
      }

      // Owned fish array
      // Each fish: {
      //   id, x, y, direction, targetFoodId, foodEaten,
      //   currentSpeed, currentEarning,
      //   targetTime (how many seconds they've chased the current coin)
      // }
      let ownedFish = [];

      // FOOD DEFINITIONS
      const foodTypes = [
        { type: 'basic',   color: '#ffcc00', coinValue: 1 },
        { type: 'premium', color: '#ff66ff', coinValue: 5 },
        { type: 'gold',    color: '#00ff00', coinValue: 10 }
      ];
      /*
        We'll store each spawned food in foodItems:
        {
          id, x, y, finalY, dropComplete, hoverPhase,
          coinValue, color, targetedByFishId
        }
      */
      let foodItems = [];

      // GLOBAL UPGRADES
      const globalUpgrades = [
        {
          id: 1,
          name: 'Coin Multiplier 1',
          description: 'All fish earn +25% coins per food.',
          cost: 500,
          purchased: false,
          effect: () => {
            ownedFish.forEach(f => {
              f.currentEarning *= 1.25;
            });
            // Also multiply base stats so newly purchased fish get the benefit
            fishTypes.forEach(ft => {
              ft.baseEarning *= 1.25;
            });
          }
        },
        {
          id: 2,
          name: 'Speed Booster 1',
          description: 'All fish swim +20% faster.',
          cost: 750,
          purchased: false,
          effect: () => {
            ownedFish.forEach(f => {
              f.currentSpeed *= 1.2;
            });
            fishTypes.forEach(ft => {
              ft.baseSpeed *= 1.2;
            });
          }
        },
        {
          id: 3,
          name: 'Coin Multiplier 2',
          description: 'All fish earn +50% coins per food.',
          cost: 4000,
          purchased: false,
          effect: () => {
            ownedFish.forEach(f => {
              f.currentEarning *= 1.5;
            });
            fishTypes.forEach(ft => {
              ft.baseEarning *= 1.5;
            });
          }
        },
        {
          id: 4,
          name: 'Speed Booster 2',
          description: 'All fish swim +40% faster.',
          cost: 5000,
          purchased: false,
          effect: () => {
            ownedFish.forEach(f => {
              f.currentSpeed *= 1.4;
            });
            fishTypes.forEach(ft => {
              ft.baseSpeed *= 1.4;
            });
          }
        }
      ];

      // EXPANSIONS
      const expansions = [
        {
          id: 1,
          name: 'Turtle',
          description: 'Generates 1 coin/s each. +10% synergy for every 10 Turtles.',
          cost: 200,
          purchasedCount: 0,
          baseEffect: 1, // coin/s each
          effectType: 'coins',
          effectRate: 1,
          synergy: 0.1
        },
        {
          id: 2,
          name: 'Crab',
          description: 'Generates 5 coin/s each. +15% for every 5 Crabs.',
          cost: 1000,
          purchasedCount: 0,
          baseEffect: 5,
          effectType: 'coins',
          effectRate: 1,
          synergy: 0.15
        },
        {
          id: 3,
          name: 'Auto Feeder',
          description: 'Drops extra food automatically (0.2 foods/s each).',
          cost: 500,
          purchasedCount: 0,
          baseEffect: 1, 
          effectType: 'food',
          effectRate: 0.2,
          synergy: 0
        },
        {
          id: 4,
          name: 'Seahorse',
          description: 'Generates 10 coin/s each. +20% synergy every 5 Seahorses.',
          cost: 5000,
          purchasedCount: 0,
          baseEffect: 10,
          effectType: 'coins',
          effectRate: 1,
          synergy: 0.2
        },
        {
          id: 5,
          name: 'Treasure Chest',
          description: 'Yields 50 coin/s each. +10% synergy per chest itself (stacks).',
          cost: 20000,
          purchasedCount: 0,
          baseEffect: 50,
          effectType: 'coins',
          effectRate: 1,
          synergy: 0.10
        }
      ];

      // ACHIEVEMENTS
      const achievements = [
        {
          id: 1,
          name: 'First Fish',
          description: 'Purchase your first fish.',
          achieved: false,
          condition: () => ownedFish.length >= 1
        },
        {
          id: 2,
          name: 'Wealthy (1k)',
          description: 'Accumulate 1,000 coins.',
          achieved: false,
          condition: () => coins >= 1000
        },
        {
          id: 3,
          name: 'Feeding Frenzy',
          description: 'Consume 50 pieces of food in total.',
          achieved: false,
          condition: () => ownedFish.reduce((sum, f) => sum + f.foodEaten, 0) >= 50
        },
        {
          id: 4,
          name: 'Expansive',
          description: 'Purchase at least one of any expansion.',
          achieved: false,
          condition: () => expansions.some(e => e.purchasedCount > 0)
        },
        {
          id: 5,
          name: 'Coin Hoarder (10k)',
          description: 'Accumulate 10,000 coins.',
          achieved: false,
          condition: () => coins >= 10000
        },
        {
          id: 6,
          name: 'Food Master (200)',
          description: 'Consume 200 pieces of food in total.',
          achieved: false,
          condition: () => ownedFish.reduce((sum, f) => sum + f.foodEaten, 0) >= 200
        },
        {
          id: 7,
          name: 'Mega Hoarder (100k)',
          description: 'Accumulate 100,000 coins.',
          achieved: false,
          condition: () => coins >= 100000
        },
        {
          id: 8,
          name: 'Sea Emperor',
          description: 'Own at least 50 fish in total.',
          achieved: false,
          condition: () => ownedFish.length >= 50
        }
      ];

      let bubbleTimer, saveInterval, expansionsInterval;
      let achievementNotifications = 0;
      let lastUpdateTime = Date.now();


      /*
        ======================================================
        =============== LOADING & SAVING GAME ================
        ======================================================
      */
      const initializeDefaultData = () => {
        coins = 0;
        ownedFish = [
          {
            id: 1,
            x: 100,
            y: 100,
            direction: 'right',
            targetFoodId: null,
            foodEaten: 0,
            currentSpeed: fishTypes[0].baseSpeed,
            currentEarning: fishTypes[0].baseEarning,
            targetTime: 0
          }
        ];
        globalUpgrades.forEach(u => { u.purchased = false; });
        expansions.forEach(e => { e.purchasedCount = 0; });
        achievements.forEach(a => { a.achieved = false; });
        fishTypes.forEach(ft => {
          ft.upgrades.forEach(u => { u.purchasedCount = 0; });
        });
        foodItems = [];
      };

      const loadGame = () => {
        if (!localStorage.getItem('hasData')) {
          initializeDefaultData();
          return;
        }
        // Load coins
        const savedCoins = localStorage.getItem('coins');
        if (savedCoins) coins = parseFloat(savedCoins);

        // Load fish
        const savedFish = localStorage.getItem('ownedFish');
        if (savedFish) ownedFish = JSON.parse(savedFish);

        // Rebuild fish stats if we have fish
        ownedFish.forEach(f => {
          const ft = fishTypes[f.id - 1];
          if (!ft) return;
          const totalSpeedUp = ft.upgrades.find(u => u.id === `speed-${ft.id}`)?.purchasedCount || 0;
          const totalEarningUp = ft.upgrades.find(u => u.id === `earning-${ft.id}`)?.purchasedCount || 0;
          f.currentSpeed = ft.baseSpeed + totalSpeedUp;
          f.currentEarning = ft.baseEarning + totalEarningUp;
          // If targetTime not defined, define it:
          if (typeof f.targetTime === 'undefined') {
            f.targetTime = 0;
          }
        });

        if (ownedFish.length === 0) {
          const ft = fishTypes[0];
          ownedFish.push({
            id: 1,
            x: 100,
            y: 100,
            direction: 'right',
            targetFoodId: null,
            foodEaten: 0,
            currentSpeed: ft.baseSpeed,
            currentEarning: ft.baseEarning,
            targetTime: 0
          });
        }

        // Load global upgrades
        const savedUpgrades = localStorage.getItem('globalUpgrades');
        if (savedUpgrades) {
          const purchasedList = JSON.parse(savedUpgrades);
          purchasedList.forEach(uId => {
            const upg = globalUpgrades.find(u => u.id === uId);
            if (upg && !upg.purchased) {
              upg.purchased = true;
              upg.effect();
            }
          });
        }

        // Load expansions
        const savedExpansions = localStorage.getItem('expansions');
        if (savedExpansions) {
          const expansionsData = JSON.parse(savedExpansions);
          expansionsData.forEach(e => {
            const ex = expansions.find(x => x.id === e.id);
            if (ex) ex.purchasedCount = e.purchasedCount;
          });
        }

        // Load achievements
        const savedAchievements = localStorage.getItem('achievements');
        if (savedAchievements) {
          const achData = JSON.parse(savedAchievements);
          achData.forEach(aId => {
            const a = achievements.find(x => x.id === aId);
            if (a) a.achieved = true;
          });
        }

        // Load fish upgrades
        const savedFishUpgrades = localStorage.getItem('fishUpgrades');
        if (savedFishUpgrades) {
          const fishUpgradesData = JSON.parse(savedFishUpgrades);
          fishUpgradesData.forEach(fu => {
            const ft = fishTypes.find(x => x.id === fu.fishTypeId);
            if (ft) {
              fu.upgrades.forEach(up => {
                const matchUp = ft.upgrades.find(m => m.id === up.id);
                if (matchUp) {
                  matchUp.purchasedCount = up.purchasedCount;
                }
              });
            }
          });
        }

        // Idle generation
        const savedLastUpdate = localStorage.getItem('lastUpdateTime');
        if (savedLastUpdate) {
          const currentTime = Date.now();
          const elapsed = (currentTime - parseInt(savedLastUpdate)) / 1000; // seconds
          expansions.forEach(exp => {
            if (exp.purchasedCount > 0) {
              if (exp.effectType === 'coins') {
                let synergyMult = 1;
                if (exp.synergy && exp.synergy > 0) {
                  synergyMult += Math.floor(exp.purchasedCount / 10) * exp.synergy;
                }
                coins += exp.baseEffect * exp.purchasedCount * synergyMult * exp.effectRate * elapsed;
              } else if (exp.effectType === 'food') {
                const spawnRate = exp.baseEffect * exp.purchasedCount * exp.effectRate;
                const totalFoods = Math.floor(spawnRate * elapsed);
                for (let i = 0; i < totalFoods; i++) {
                  spawnFood();
                }
              }
            }
          });
        }
        lastUpdateTime = parseInt(localStorage.getItem('lastUpdateTime')) || Date.now();
      };

      const saveGame = () => {
        localStorage.setItem('coins', coins);
        localStorage.setItem('ownedFish', JSON.stringify(ownedFish));

        const purchasedGlobalUpg = globalUpgrades.filter(u => u.purchased).map(u => u.id);
        localStorage.setItem('globalUpgrades', JSON.stringify(purchasedGlobalUpg));

        const expansionsData = expansions.map(e => ({ id: e.id, purchasedCount: e.purchasedCount }));
        localStorage.setItem('expansions', JSON.stringify(expansionsData));

        const achievedList = achievements.filter(a => a.achieved).map(a => a.id);
        localStorage.setItem('achievements', JSON.stringify(achievedList));

        // Save fishUpgrades
        const fishUpgradesData = fishTypes.map(ft => {
          return {
            fishTypeId: ft.id,
            upgrades: ft.upgrades.map(u => ({
              id: u.id,
              purchasedCount: u.purchasedCount
            }))
          };
        });
        localStorage.setItem('fishUpgrades', JSON.stringify(fishUpgradesData));

        localStorage.setItem('lastUpdateTime', Date.now());
        localStorage.setItem('hasData', 'true');
      };

      // Thorough reset: clear localStorage & re-init game data
      const resetAllData = () => {
        if (confirm('Are you sure you want to reset ALL progress? This cannot be undone.')) {
          localStorage.clear();
          initializeDefaultData();
          renderFish();
          renderFoodItems();
          updateCoinDisplay();
          alert('All data has been reset!');
        }
      };


      /*
        ======================================================
        ===================== RENDER UI ======================
        ======================================================
      */
      const updateCoinDisplay = () => {
        $('#coin-count').text(Math.floor(coins));
        checkAchievements();
      };

      // ========== STORE UI ==========
      const showFishTooltip = (evt, fish) => {
        const tooltip = $('#fish-tooltip');
        let info = `
          <strong>${fish.name}</strong><br>
          Cost: ${Math.floor(fish.cost)}<br>
          Base Speed: ${fish.baseSpeed.toFixed(2)}<br>
          Base Earning: ${fish.baseEarning.toFixed(2)}<br>
          <em>Upgrades Purchased:</em><br>
        `;
        fish.upgrades.forEach(up => {
          info += `${up.name}: +${up.purchasedCount}<br>`;
        });
        tooltip.html(info);
        tooltip.css({
          display: 'block',
          left: evt.pageX + 10 + 'px',
          top: evt.pageY + 'px'
        });
      };
      const hideFishTooltip = () => { $('#fish-tooltip').hide(); };

      const renderStore = () => {
        $('#store-items').empty();
        fishTypes.forEach(f => {
          const ownedCount = ownedFish.filter(x => x.id === f.id).length;
          const row = $(`
            <div class="item-row fish-store-item" data-fid="${f.id}">
              <div style="position: relative;">
                <img src="${f.image}" alt="${f.name}">
                <span>${f.name} (Owned: ${ownedCount})</span>
              </div>
              <div>
                <button data-id="${f.id}">Buy (${Math.floor(f.cost)} coins)</button>
              </div>
            </div>
          `);
          $('#store-items').append(row);
        });
      };

      // ========== GLOBAL UPGRADES UI ==========
      const renderGlobalUpgrades = () => {
        $('#upgrade-items').empty();
        globalUpgrades.forEach(u => {
          const btnText = u.purchased ? 'Purchased' : `Buy (${Math.floor(u.cost)} coins)`;
          const disabled = u.purchased ? 'disabled' : '';
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${u.name}</strong>
                <p>${u.description}</p>
              </div>
              <div>
                <button data-id="${u.id}" ${disabled}>${btnText}</button>
              </div>
            </div>
          `);
          $('#upgrade-items').append(row);
        });
      };

      // ========== EXPANSIONS UI ==========
      const renderExpansions = () => {
        $('#expansion-items').empty();
        expansions.forEach(e => {
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${e.name}</strong>
                <p>${e.description}</p>
                <p>Owned: ${e.purchasedCount}</p>
              </div>
              <div>
                <button data-id="${e.id}">Buy (${Math.floor(e.cost)} coins)</button>
              </div>
            </div>
          `);
          $('#expansion-items').append(row);
        });
      };

      // ========== ACHIEVEMENTS UI ==========
      const renderAchievements = () => {
        $('#achievement-items').empty();
        achievements.forEach(a => {
          const status = a.achieved
            ? '<span class="badge bg-success">Achieved</span>'
            : '<span class="badge bg-secondary">Locked</span>';
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${a.name}</strong>
                <p>${a.description}</p>
              </div>
              <div>${status}</div>
            </div>
          `);
          $('#achievement-items').append(row);
        });
      };


      /*
        ======================================================
        ============= FISH & FOOD RENDERING/LOGIC ============
        ======================================================
      */
      const renderFish = () => {
        $('#aquarium .fish').remove();
        ownedFish.forEach((f, index) => {
          const ft = fishTypes[f.id - 1];
          const fishDiv = $(`<div class="fish" data-index="${index}"></div>`);
          fishDiv.css({
            left: f.x + 'px',
            top: f.y + 'px',
            backgroundImage: `url(${ft.image})`,
            transform: f.direction === 'left' ? 'scaleX(-1)' : 'scaleX(1)'
          });
          $('#aquarium').append(fishDiv);
        });
      };

      const renderFoodItems = () => {
        $('#aquarium .food').remove();
        foodItems.forEach(food => {
          const fd = $(`<div class="food"></div>`);
          fd.attr('data-id', food.id);
          fd.css({
            left: food.x + 'px',
            top: food.y + 'px',
            backgroundColor: food.color
          });
          $('#aquarium').append(fd);
        });
      };

      // Greedy Assignment: Assign each coin to the closest available fish
      function assignCoinsToFish() {
        // Reset all assignments
        ownedFish.forEach(f => { f.targetFoodId = null; });
        
        // Create a list of all possible fish-coin pairs with their distances
        let pairs = [];
        ownedFish.forEach(fish => {
          foodItems.forEach(coin => {
            const dx = coin.x - fish.x;
            const dy = coin.y - fish.y;
            const dist = Math.hypot(dx, dy);
            pairs.push({ fish, coin, dist });
          });
        });

        // Sort the pairs by distance ascending
        pairs.sort((a, b) => a.dist - b.dist);

        // Keep track of assigned fish and coins
        const assignedFish = new Set();
        const assignedCoins = new Set();

        // Assign closest pairs first
        pairs.forEach(pair => {
          if (!assignedFish.has(pair.fish) && !assignedCoins.has(pair.coin.id)) {
            pair.fish.targetFoodId = pair.coin.id;
            pair.fish.targetTime = 0; // Reset target time
            assignedFish.add(pair.fish);
            assignedCoins.add(pair.coin.id);
          }
        });
      }

      // 7-second stale assignment check: If fish has had the same coin for 7+ seconds, unassign
      function updateStaleAssignments(dt) {
        ownedFish.forEach(f => {
          if (f.targetFoodId) {
            f.targetTime += dt;
            if (f.targetTime >= STALE_ASSIGNMENT_LIMIT) {
              // Unassign
              f.targetFoodId = null;
              f.targetTime = 0;
            }
          } else {
            // If fish doesn't have a target coin, reset timer
            f.targetTime = 0;
          }
        });
      }

      // Move fish, handle collisions with assigned coin
      const moveFish = (dt) => {
        // 1) Assign coins
        assignCoinsToFish();
        // 2) Check stale assignment
        updateStaleAssignments(dt);

        ownedFish.forEach((fish, index) => {
          const targetFood = foodItems.find(fd => fd.id === fish.targetFoodId);
          if (targetFood) {
            const dx = targetFood.x - fish.x;
            const dy = targetFood.y - fish.y;
            const dist = Math.hypot(dx, dy);

            fish.direction = dx < 0 ? 'left' : 'right';
            const speed = fish.currentSpeed || 1.5;

            if (dist <= speed) {
              // Reached the coin
              const earning = fish.currentEarning || 1;
              const totalCoins = earning * targetFood.coinValue;
              coins += totalCoins;
              updateCoinDisplay();

              fish.foodEaten++;
              createFloatingText(targetFood.x, targetFood.y, `+${totalCoins}`);

              // Remove coin
              foodItems = foodItems.filter(fd => fd.id !== targetFood.id);

              // Reset fish assignment
              fish.targetFoodId = null;
              fish.targetTime = 0;
            } else {
              // Move closer
              fish.x += (dx / dist) * speed;
              fish.y += (dy / dist) * speed;
            }
          } else {
            // Ambient drifting
            if (fish.targetFoodId === null) {
              fish.targetTime = 0; // reset
              const angle = Math.random() * 2 * Math.PI;
              fish.x += Math.cos(angle) * 0.3;
              fish.y += Math.sin(angle) * 0.3;
            }
          }

          // Constrain fish
          const fishW = 48;
          const fishH = 32;
          const winW = $(window).width();
          const winH = $(window).height();
          fish.x = Math.max(0, Math.min(winW - fishW, fish.x));
          fish.y = Math.max(0, Math.min(winH - fishH, fish.y));

          // Update DOM
          const fishDiv = $(`.fish[data-index="${index}"]`);
          fishDiv.css({
            left: fish.x + 'px',
            top: fish.y + 'px',
            transform: fish.direction === 'left' ? 'scaleX(-1)' : 'scaleX(1)'
          });
        });
      };

      /*
        FOOD DROPPING:
        We'll keep a 40px margin on all sides, so no coin spawns on the extreme edges.
      */
      const spawnFood = () => {
        const pick = Math.random();
        let chosen = foodTypes[0];
        if (pick < 0.7) chosen = foodTypes[0];
        else if (pick < 0.9) chosen = foodTypes[1];
        else chosen = foodTypes[2];

        const winW = $(window).width();
        const winH = $(window).height();
        const spawnX = Math.random() * (winW - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN;
        // finalY from 40% to 80% of screen, but also with margin
        const minFinalY = Math.max(winH * 0.4, COIN_SPAWN_MARGIN);
        const maxFinalY = Math.min(winH * 0.8, winH - COIN_SPAWN_MARGIN);
        const chosenFinalY = Math.random() * (maxFinalY - minFinalY) + minFinalY;

        const fObj = {
          id: Date.now() + Math.random(),
          x: spawnX,
          y: COIN_SPAWN_MARGIN / 2,               // drop from near top, within margin
          finalY: chosenFinalY,
          dropComplete: false,
          hoverPhase: 0,
          coinValue: chosen.coinValue,
          color: chosen.color,
          targetedByFishId: null
        };
        foodItems.push(fObj);
      };

      // Move food each frame
      const moveFood = () => {
        foodItems.forEach(food => {
          if (!food.dropComplete) {
            const dropSpeed = 1.0;
            if (food.y < food.finalY) {
              food.y += dropSpeed;
              if (food.y >= food.finalY) {
                food.y = food.finalY;
                food.dropComplete = true;
              }
            }
          } else {
            // Hover
            food.hoverPhase += 0.04;
            const amplitude = 3;
            const offsetY = amplitude * Math.sin(food.hoverPhase);
            food.y = food.finalY + offsetY;
          }
        });
      };

      // Floating text
      const createFloatingText = (x, y, text) => {
        const ft = $(`<div class="floating-text">${text}</div>`);
        ft.css({ left: x + 'px', top: y + 'px' });
        $('#aquarium').append(ft);
        setTimeout(() => { ft.remove(); }, 2000);
      };


      /*
        ======================================================
        ==================== EXPANSIONS ======================
        ======================================================
      */
      const runExpansions = () => {
        expansions.forEach(exp => {
          if (exp.purchasedCount > 0) {
            if (exp.effectType === 'coins') {
              let synergyMult = 1;
              if (exp.synergy && exp.synergy > 0) {
                synergyMult += Math.floor(exp.purchasedCount / 10) * exp.synergy;
              }
              coins += exp.baseEffect * exp.purchasedCount * synergyMult * exp.effectRate;
            } else if (exp.effectType === 'food') {
              let spawnRate = exp.baseEffect * exp.purchasedCount * exp.effectRate;
              const integerSpawn = Math.floor(spawnRate);
              for (let i = 0; i < integerSpawn; i++) {
                spawnFood();
              }
            }
          }
        });
        updateCoinDisplay();
      };


      /*
        ======================================================
        ================== ACHIEVEMENTS ======================
        ======================================================
      */
      const checkAchievements = () => {
        achievements.forEach(a => {
          if (!a.achieved && a.condition()) {
            a.achieved = true;
            achievementNotifications++;
            alert(`Achievement Unlocked: ${a.name}`);
          }
        });
        if (achievementNotifications > 0) {
          $('.achievements-button').addClass('has-new-achievements');
          $('.achievements-button').attr('data-badge', achievementNotifications);
        }
      };


      /*
        ======================================================
        ==================== BUBBLES =========================
        ======================================================
      */
      const spawnBubble = () => {
        const bubble = $('<div class="bubble"></div>');
        const startX = Math.random() * ($(window).width() - 10);
        bubble.css({ left: startX + 'px', bottom: '0px' });
        $('#aquarium').append(bubble);
        setTimeout(() => { bubble.remove(); }, 5000);
      };


      /*
        ======================================================
        ================== EVENT HANDLERS ====================
        ======================================================
      */
      const openModal = sel => { $(sel).fadeIn(); };
      const closeModal = sel => { $(sel).fadeOut(); };

      $('.store-button').click(() => {
        renderStore();
        openModal('.store-modal');
      });
      $('.upgrades-button').click(() => {
        renderGlobalUpgrades();
        openModal('.upgrades-modal');
      });
      $('.expansions-button').click(() => {
        renderExpansions();
        openModal('.expansions-modal');
      });
      $('.achievements-button').click(() => {
        renderAchievements();
        openModal('.achievements-modal');
        achievementNotifications = 0;
        $('.achievements-button').removeClass('has-new-achievements');
        $('.achievements-button').attr('data-badge', 0);
      });
      $('.reset-button').click(() => {
        resetAllData();
      });
      $('.close-modal').click(function() {
        closeModal($(this).closest('.modal-overlay'));
      });

      // Hover tooltip for fish stats
      $('#store-items').on('mouseenter', '.fish-store-item', function(e) {
        const fid = parseInt($(this).data('fid'));
        const fish = fishTypes.find(x => x.id === fid);
        showFishTooltip(e, fish);
      });
      $('#store-items').on('mousemove', '.fish-store-item', function(e) {
        const fid = parseInt($(this).data('fid'));
        const fish = fishTypes.find(x => x.id === fid);
        showFishTooltip(e, fish);
      });
      $('#store-items').on('mouseleave', '.fish-store-item', function() {
        hideFishTooltip();
      });

      // Store -> Buy Fish
      $('#store-items').on('click', 'button', function() {
        const fishId = parseInt($(this).data('id'));
        const ft = fishTypes.find(f => f.id === fishId);
        if (!ft) return;
        if (coins >= ft.cost) {
          coins -= ft.cost;
          updateCoinDisplay();
          // Recompute stats in case any fish upgrades
          const totalSpeedUp = ft.upgrades.find(u => u.id === `speed-${ft.id}`)?.purchasedCount || 0;
          const totalEarningUp = ft.upgrades.find(u => u.id === `earning-${ft.id}`)?.purchasedCount || 0;
          ownedFish.push({
            id: ft.id,
            x: Math.random() * ($(window).width() - 48),
            y: Math.random() * ($(window).height() - 32),
            direction: 'right',
            targetFoodId: null,
            foodEaten: 0,
            currentSpeed: ft.baseSpeed + totalSpeedUp,
            currentEarning: ft.baseEarning + totalEarningUp,
            targetTime: 0
          });
          renderFish();
          checkAchievements();
        } else {
          alert('Not enough coins!');
        }
      });

      // Buy Global Upgrades
      $('#upgrade-items').on('click', 'button', function() {
        const upgId = parseInt($(this).data('id'));
        const upg = globalUpgrades.find(u => u.id === upgId);
        if (!upg || upg.purchased) return;
        if (coins >= upg.cost) {
          coins -= upg.cost;
          upg.purchased = true;
          upg.effect();
          updateCoinDisplay();
          renderGlobalUpgrades();
        } else {
          alert('Not enough coins!');
        }
      });

      // Buy Expansions
      $('#expansion-items').on('click', 'button', function() {
        const expId = parseInt($(this).data('id'));
        const ex = expansions.find(e => e.id === expId);
        if (!ex) return;
        if (coins >= ex.cost) {
          coins -= ex.cost;
          ex.purchasedCount++;
          updateCoinDisplay();
          renderExpansions();
          checkAchievements();
        } else {
          alert('Not enough coins!');
        }
      });

      // Spacebar -> Drop manual basic food
      $(document).keydown(e => {
        if (e.code === 'Space') {
          e.preventDefault();
          spawnManualFood();
        }
      });
      const spawnManualFood = () => {
        const chosen = foodTypes[0]; // Always basic for manual
        const spawnX = Math.random() * ($(window).width() - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN;
        const winH = $(window).height();
        const minFinalY = Math.max(winH * 0.4, COIN_SPAWN_MARGIN);
        const maxFinalY = Math.min(winH * 0.8, winH - COIN_SPAWN_MARGIN);
        const chosenFinalY = Math.random() * (maxFinalY - minFinalY) + minFinalY;
        const fObj = {
          id: Date.now() + Math.random(),
          x: spawnX,
          y: COIN_SPAWN_MARGIN / 2,
          finalY: chosenFinalY,
          dropComplete: false,
          hoverPhase: 0,
          coinValue: chosen.coinValue,
          color: chosen.color,
          targetedByFishId: null
        };
        foodItems.push(fObj);
      };


      /*
        ======================================================
        =================== MAIN GAME LOOP ===================
        ======================================================
      */
      let lastFrameTime = performance.now();
      const gameLoop = (now) => {
        const dt = (now - lastFrameTime) / 1000; // in seconds
        lastFrameTime = now;

        moveFish(dt);
        moveFood();
        renderFoodItems();

        requestAnimationFrame(gameLoop);
      };


      /*
        ======================================================
        ===================== INIT & START ===================
        ======================================================
      */
      loadGame();
      renderFish();
      renderFoodItems();
      updateCoinDisplay();

      // Start main loop
      requestAnimationFrame((t) => {
        lastFrameTime = t;
        gameLoop(t);
      });

      // Periodic spawning of random food
      setInterval(spawnFood, 4000);

      // Expansions effect loop
      expansionsInterval = setInterval(runExpansions, 1000);

      // Ambient bubbles
      bubbleTimer = setInterval(spawnBubble, 2000);

      // Auto-save
      saveInterval = setInterval(saveGame, 15000);

      // Save once before closing
      $(window).on('beforeunload', () => {
        saveGame();
      });
    });
  </script>
</body>
</html>
