<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pixel Fish Aquarium Idle - Enhanced Edition V4</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* ******************** PIXEL THEME ******************** */
    * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; }
    html, body { width: 100%; height: 100%; font-family: 'Press Start 2P', sans-serif; overflow: hidden; position: relative; background: linear-gradient(to bottom right, #1e3d59, #2a5273); }

    /* ******************** TOP BAR ************************ */
    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 999;
    }
    .navbar {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 7px;
      padding: 5px 10px;
      font-size: 14px;
      user-select: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .navbar .navbar-brand {
      font-size: 16px;
      margin-right: 15px;
      display: flex;
      align-items: center;
    }
    .navbar .coin-display {
      margin-left: 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    .navbar .nav-link, .navbar .dropdown-toggle {
      cursor: pointer;
      transition: background-color 0.3s;
      padding: 8px 12px;
      border-radius: 5px;
      margin-right: 5px;
      display: inline-block;
    }
    .navbar .nav-link:hover, .navbar .dropdown-toggle:hover {
      background-color: rgba(255, 255, 255, 1);
    }
    .coin-display span { margin-left: 5px; }

    /* ******************** AQUARIUM ************************ */
    #aquarium { position: relative; width: 100%; height: 100%; overflow: hidden; background-image: url('aquarium_bg.png'); background-size: cover; background-position: center; }
    #aquarium.bg-coral { background-image: url('aquarium_bg_coral.png'); }
    #aquarium.bg-ruins { background-image: url('aquarium_bg_ruins.png'); }
    #aquarium.bg-cave { background-image: url('aquarium_bg_cave.png'); }

    /* ******************** FISH *************************** */
    .fish { position: absolute; background-size: contain; background-repeat: no-repeat; transform-origin: center; transition: transform 0.3s, left 0.3s linear, top 0.3s linear, filter 0.3s; width: 96px; height: 64px; }

    /* ******************** FOOD **************************** */
    .food { position: absolute; width: 32px; height: 32px; border-radius: 50%; z-index: 500; }
    .food.food-boost { border: 3px dashed yellow; }
    .food.food-growth { border: 3px dashed lightgreen; }
    .food.food-attract { border: 3px dashed lightblue; }
    .food-effect-text { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); color: white; font-size: 11px; text-shadow: 1px 1px black; white-space: nowrap; }

    /* ******************** DECORATIONS ********************* */
    .decoration { position: absolute; background-size: contain; background-repeat: no-repeat; z-index: 100; }
    .decoration.plant { width: 64px; height: 96px; background-image: url('plant_1.png'); }
    .decoration.rock { width: 96px; height: 48px; background-image: url('rock_1.png'); }
    .decoration.castle { width: 128px; height: 96px; background-image: url('castle_1.png'); }
    .decoration.background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .decoration.background.coralbg { background-image: url('aquarium_bg_coral_thumb.png'); width: 120px; height: 80px; }
    .decoration.background.ruinsbg { background-image: url('aquarium_bg_ruins_thumb.png'); width: 120px; height: 80px; }
    .decoration.background.cavebg  { background-image: url('aquarium_bg_cave_thumb.png'); width: 120px; height: 80px; }

    /* ******************** BUBBLES ************************** */
    .bubble { position: absolute; width: 15px; height: 15px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; animation: bubble-rise 5s linear infinite; pointer-events: none; opacity: 0.7; }
    @keyframes bubble-rise { 
      0%   { transform: translateY(0) scale(1); opacity: 0.7; } 
      50%  { transform: translateY(-150px) scale(1.2); } 
      100% { transform: translateY(-300px) scale(1); opacity: 0; } 
    }

    /* ******************* FLOATING TEXT *********************** */
    .floating-text { position: absolute; color: #fff; font-size: 16px; pointer-events: none; animation: floatUp 2s ease-out forwards; text-shadow: 2px 2px 3px #000; }
    @keyframes floatUp { 
      0%   { opacity: 1;   transform: translateY(0); } 
      100% { opacity: 0;   transform: translateY(-50px); } 
    }

    /* ******************** MODAL STYLES ********************* */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 95%; max-width: 800px; max-height: 85%; overflow-y: auto; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; } to   { opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .modal-header h2 { font-size: 18px; }
    .close-modal { cursor: pointer; font-size: 24px; font-weight: bold; }
    .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ccc; }
    .item-row img { width: 80px; height: 64px; }
    .item-row button { padding: 8px 16px; background-color: #1e90ff; color: #fff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 14px; }
    .item-row button:hover { background-color: #3742fa; }
    .fish-tooltip { font-size: 12px; color: #000; background-color: #ffc; border: 1px solid #999; padding: 6px; border-radius: 5px; position: absolute; z-index: 3000; display: none; pointer-events: none; }
    .color-palette { display: flex; gap: 8px; margin-top: 10px; }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.3s; }
    .color-swatch:hover, .color-swatch.selected { border-color: black; }
    .food-crate-preview { display: flex; gap: 5px; align-items: center; }
    .food-crate-preview img { width: 24px; height: 24px; border-radius: 50%; }

    /* ************** ACHIEVEMENTS BUTTON BADGE *************** */
    .achievements-button { position: relative; }
    .achievements-button::after { content: attr(data-badge); position: absolute; top: -8px; right: -15px; background: red; color: white; border-radius: 50%; padding: 4px 8px; font-size: 12px; display: none; }
    .has-new-achievements.achievements-button::after { display: block; }

    /* ******************** TOAST MESSAGE ******************* */
    #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
    .toast-message { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 12px 25px; margin-bottom: 12px; border-radius: 7px; font-size: 14px; opacity: 0; animation: slideInFadeOut 3s forwards; }
    @keyframes slideInFadeOut { 
      0% { opacity: 0; transform: translateY(-20px); } 
      10%, 90% { opacity: 1; transform: translateY(0); } 
      100% { opacity: 0; transform: translateY(-20px); } 
    }

    /* ******************** DAILY REWARD ******************** */
    .daily-reward-button.claimed { opacity: 0.6; pointer-events: none; }

    /* ******************* RESPONSIVE DESIGN ****************** */
    @media (max-width: 768px) {
      .navbar .navbar-brand { font-size: 14px; }
      .navbar .coin-display { font-size: 12px; margin-left: 10px; }
      .navbar .nav-link, .navbar .dropdown-toggle { font-size: 12px; padding: 6px 8px; }
      .fish { width: 72px; height: 48px; }
      .food { width: 24px; height: 24px; }
      .item-row img { width: 60px; height: 48px; }
      .item-row button { padding: 6px 12px; font-size: 12px; }
      .floating-text { font-size: 14px; }
      .fish-tooltip { font-size: 10px; padding: 4px; }
      .toast-message { font-size: 12px; padding: 10px 20px; }
      .modal-content { padding: 15px; }
      .modal-header h2 { font-size: 16px; }
      .close-modal { font-size: 20px; }
      .color-swatch { width: 25px; height: 25px; }
    }
  </style>
</head>

<body>
  <!-- ================== TOP BAR ================== -->
  <div class="top-bar">
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid p-0">
        <span class="navbar-brand d-flex align-items-center">
          Idle Aquarium
          <!-- Added margin and distinct styling for coin display -->
          <div class="coin-display ms-4 text-primary fw-bold">
            Coins: <span id="coin-count">0</span>
          </div>
        </span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu" aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
          ☰
        </button>
        <div class="collapse navbar-collapse" id="navbarMenu">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <!-- Store Dropdown -->
            <li class="nav-item dropdown">
              <span class="nav-link dropdown-toggle" id="storeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Store
              </span>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li><span class="dropdown-item store-button">Fish Store</span></li>
                <li><span class="dropdown-item decorations-button">Decorations</span></li>
                <li><span class="dropdown-item crates-button">Food Crates</span></li>
              </ul>
            </li>
            <!-- Upgrades Dropdown -->
            <li class="nav-item dropdown">
              <span class="nav-link dropdown-toggle" id="upgradesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Upgrades
              </span>
              <ul class="dropdown-menu" aria-labelledby="upgradesDropdown">
                <li><span class="dropdown-item upgrades-button">Global Upgrades</span></li>
                <!-- Add more upgrade types if needed -->
              </ul>
            </li>
            <!-- Expansions -->
            <li class="nav-item">
              <span class="nav-link expansions-button">Expansions</span>
            </li>
            <!-- Customize -->
            <li class="nav-item">
              <span class="nav-link customize-button">Customize</span>
            </li>
            <!-- Achievements -->
            <li class="nav-item">
              <span class="nav-link achievements-button" data-badge="0">Achievements</span>
            </li>
            <!-- Daily Reward -->
            <li class="nav-item">
              <span class="nav-link daily-reward-button">Daily Reward</span>
            </li>
            <!-- Reset -->
            <li class="nav-item">
              <span class="nav-link reset-button">Reset All</span>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div>
  
  <!-- ================== AQUARIUM ================== -->
  <div id="aquarium"></div>

  <!-- ================== MODALS ================== -->
  <!-- Store Modal -->
  <div class="modal-overlay store-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Fish Store</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="store-items"></div>
    </div>
  </div>

  <!-- Upgrades Modal -->
  <div class="modal-overlay upgrades-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Global Upgrades</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="upgrade-items"></div>
    </div>
  </div>

  <!-- Expansions Modal -->
  <div class="modal-overlay expansions-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Expansions</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="expansion-items"></div>
    </div>
  </div>

  <!-- Decorations Modal -->
  <div class="modal-overlay decorations-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Decorations Store</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="decoration-items"></div>
    </div>
  </div>

  <!-- Customize Modal -->
  <div class="modal-overlay customize-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Customize Fish Color</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="customize-items">
        <p>Choose a color palette for your fish:</p>
        <div id="color-palettes"></div>
      </div>
    </div>
  </div>

  <!-- Achievements Modal -->
  <div class="modal-overlay achievements-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Achievements</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="achievement-items"></div>
    </div>
  </div>

  <!-- Daily Reward Modal -->
  <div class="modal-overlay daily-reward-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Daily Reward</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="daily-reward-items">
        <p>Come back daily to claim your reward!</p>
        <button id="claim-daily-reward">Claim Reward</button>
        <p id="daily-reward-status"></p>
      </div>
    </div>
  </div>

  <!-- Food Crates Modal -->
  <div class="modal-overlay crates-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Food Crates</h2>
        <span class="close-modal">×</span>
      </div>
      <div id="crates-items">
        <p>Use coins to purchase Food Crates for extra food items.</p>
        <div class="item-row">
            <div><strong>Basic Food Crate</strong><p>Guaranteed basic food, chance for premium.</p></div>
            <div><button data-crate-type="basic">Buy (150 Coins)</button></div>
        </div>
        <div class="item-row">
            <div><strong>Premium Food Crate</strong><p>Guaranteed premium food, chance for gold or boost.</p></div>
            <div><button data-crate-type="premium">Buy (500 Coins)</button></div>
        </div>
        <div id="crate-purchase-status"></div>
      </div>
    </div>
  </div>

  <!-- Toast Message Container -->
  <div id="toast-container"></div>

  <!-- Tooltip for fish stats -->
  <div class="fish-tooltip" id="fish-tooltip"></div>

  <script>
    $(document).ready(() => {
      /* ======== GAME DATA ======== */
      let coins = 0;
      let fishColorPalette = 'default';
      let aquariumBackground = 'default';
      let lastFoodDropTime = 0;
      let comboMultiplier = 1;

      // Constants
      const COIN_SPAWN_MARGIN = 60;
      const FOOD_DETECT_RANGE_Y = 30;
      const DAILY_REWARD_COINS = 500;
      const FOOD_COMBO_WINDOW = 2000; // 2 seconds to maintain combo

      // FISH DEFINITIONS
      const fishTypes = [];
      for (let i = 1; i <= 10; i++) {
        fishTypes.push({
          id: i, name: "Fish " + i, cost: 50 * i, baseEarning: i,
          baseSpeed: 0.8 + i * 0.08, image: `fish_${i}.png`,
          upgrades: [
            { id: `speed-${i}`, name: `Speed +1 for Fish ${i}`, description: `Increase speed by 1`, cost: 200 * i, purchasedCount: 0 },
            { id: `earning-${i}`, name: `Earning +1 for Fish ${i}`, description: `Increase earning by 1 coin per food`, cost: 300 * i, purchasedCount: 0 }
          ]
        });
      }

      // Owned fish array
      let ownedFish = [];

      // FOOD DEFINITIONS - Enhanced food types
      const foodTypes = [
        { type: 'basic',   color: '#ffcc00', coinValue: 1, effect: null, upgradeCost: 200, upgradeIncrement: 0.25 },
        { type: 'premium', color: '#ff66ff', coinValue: 5, effect: null, upgradeCost: 800, upgradeIncrement: 1.00 },
        { type: 'gold',    color: '#00ff00', coinValue: 10, effect: null, upgradeCost: 2000, upgradeIncrement: 2.50 },
        { type: 'boost',   color: '#ffa000', coinValue: 3, effect: 'speedBoost', effectDuration: 5, upgradeCost: 3000, upgradeIncrement: 2 },
        { type: 'growth',  color: '#90ee90', coinValue: 2, effect: 'growthBoost', effectDuration: 5, upgradeCost: 4000, upgradeIncrement: 2 },
        { type: 'attract', color: '#add8e6', coinValue: 2, effect: 'attractFish', effectDuration: 3, upgradeCost: 5000, upgradeIncrement: 1 }
      ];
      let foodItems = [];

      // GLOBAL UPGRADES - Added food upgrades and auto-collect
      const globalUpgrades = [
        { id: 1, name: 'Coin Multiplier 1', description: '+25% coins per food.', cost: 500, purchased: false, effect: () => { ownedFish.forEach(f => { f.currentEarning *= 1.25; }); fishTypes.forEach(ft => { ft.baseEarning *= 1.25; }); } },
        { id: 2, name: 'Speed Booster 1', description: '+20% fish speed.', cost: 750, purchased: false, effect: () => { ownedFish.forEach(f => { f.currentSpeed *= 1.2; }); fishTypes.forEach(ft => { ft.baseSpeed *= 1.2; }); } },
        { id: 3, name: 'Coin Multiplier 2', description: '+50% coins per food.', cost: 4000, purchased: false, effect: () => { ownedFish.forEach(f => { f.currentEarning *= 1.5; }); fishTypes.forEach(ft => { ft.baseEarning *= 1.5; }); } },
        { id: 4, name: 'Speed Booster 2', description: '+40% fish speed.', cost: 5000, purchased: false, effect: () => { ownedFish.forEach(f => { f.currentSpeed *= 1.4; }); fishTypes.forEach(ft => { ft.baseSpeed *= 1.4; }); } },
        { id: 5, name: 'Food Value+', description: 'Food is worth +25% coins.', cost: 2500, purchased: false, effect: () => { foodTypes.forEach(ft => { if (ft.type !== 'boost' && ft.type !== 'growth' && ft.type !== 'attract') ft.coinValue *= 1.25; }); } },
        { id: 6, name: 'Boost Food+', description: 'Boost food effect +50% duration.', cost: 6000, purchased: false, effect: () => { const boostFood = foodTypes.find(ft => ft.type === 'boost'); if (boostFood && boostFood.effectDuration) boostFood.effectDuration *= 1.5; } },
        { id: 7, name: 'Growth Food+', description: 'Growth food effect +50% duration.', cost: 7000, purchased: false, effect: () => { const growthFood = foodTypes.find(ft => ft.type === 'growth'); if (growthFood && growthFood.effectDuration) growthFood.effectDuration *= 1.5; } },
        { id: 8, name: 'Attract Food+', description: 'Attract food effect +50% duration.', cost: 7000, purchased: false, effect: () => { const attractFood = foodTypes.find(ft => ft.type === 'attract'); if (attractFood && attractFood.effectDuration) attractFood.effectDuration *= 1.5; } },
        { id: 9, name: 'Auto-Collect Food', description: 'Auto-collect 10% coins from missed food.', cost: 12000, purchased: false, effect: () => {} }
      ];

      // EXPANSIONS
      const expansions = [
        { id: 1, name: 'Turtle', description: '1 coin/s each, +10% synergy/10.', cost: 200, purchasedCount: 0, baseEffect: 1, effectType: 'coins', effectRate: 1, synergy: 0.1 },
        { id: 2, name: 'Crab', description: '5 coin/s each, +15% synergy/5.', cost: 1000, purchasedCount: 0, baseEffect: 5, effectType: 'coins', effectRate: 1, synergy: 0.15 },
        { id: 3, name: 'Auto Feeder', description: 'Drops extra food (0.2 foods/s).', cost: 500, purchasedCount: 0, baseEffect: 1, effectType: 'food', effectRate: 0.2, synergy: 0 },
        { id: 4, name: 'Seahorse', description: '10 coin/s each, +20% synergy/5.', cost: 5000, purchasedCount: 0, baseEffect: 10, effectType: 'coins', effectRate: 1, synergy: 0.2 },
        { id: 5, name: 'Treasure Chest', description: '50 coin/s each, +10% synergy/chest.', cost: 20000, purchasedCount: 0, baseEffect: 50, effectType: 'coins', effectRate: 1, synergy: 0.10 }
      ];

      // DECORATIONS - Added backgrounds as decorations
      const decorations = [
        { id: 1, name: 'Plant', cost: 300, type: 'plant' },
        { id: 2, name: 'Rock', cost: 500, type: 'rock' },
        { id: 3, name: 'Castle', cost: 1000, type: 'castle' },
        { id: 4, name: 'Coral Reef Background', cost: 800, type: 'background', bgClass: 'bg-coral', thumbClass: 'coralbg' },
        { id: 5, name: 'Ruined City Background', cost: 1200, type: 'background', bgClass: 'bg-ruins', thumbClass: 'ruinsbg' },
        { id: 6, name: 'Deep Sea Cave Background', cost: 1500, type: 'background', bgClass: 'bg-cave', thumbClass: 'cavebg' }
      ];
      let placedDecorations = [];

      // COLOR PALETTES
      const colorPalettes = {
        'default': [],
        'sepia': ['sepia(100%)'],
        'grayscale': ['grayscale(100%)'],
        'invert': ['invert(100%)'],
        'duotone-purple': ['sepia(1) saturate(800%) hue-rotate(-240deg)'],
        'neon-blue': ['brightness(1.5) saturate(200%) hue-rotate(180deg)']
      };

      // ACHIEVEMENTS - Added new achievements
      const achievements = [
        { id: 1, name: 'First Fish', description: 'Purchase your first fish.', achieved: false, condition: () => ownedFish.length >= 1 },
        { id: 2, name: 'Wealthy (1k)', description: 'Accumulate 1,000 coins.', achieved: false, condition: () => coins >= 1000 },
        { id: 3, name: 'Feeding Frenzy', description: 'Consume 50 food.', achieved: false, condition: () => ownedFish.reduce((sum, f) => sum + f.foodEaten, 0) >= 50 },
        { id: 4, name: 'Expansive', description: 'Buy expansion.', achieved: false, condition: () => expansions.some(e => e.purchasedCount > 0) },
        { id: 5, name: 'Coin Hoarder (10k)', description: 'Accumulate 10,000 coins.', achieved: false, condition: () => coins >= 10000 },
        { id: 6, name: 'Food Master (200)', description: 'Consume 200 food.', achieved: false, condition: () => ownedFish.reduce((sum, f) => sum + f.foodEaten, 0) >= 200 },
        { id: 7, name: 'Mega Hoarder (100k)', description: 'Accumulate 100,000 coins.', achieved: false, condition: () => coins >= 100000 },
        { id: 8, name: 'Sea Emperor', description: 'Own 50 fish.', achieved: false, condition: () => ownedFish.length >= 50 },
        { id: 9, name: 'Decorator', description: 'Place 3 decorations.', achieved: false, condition: () => placedDecorations.filter(dec => dec.type !== 'background').length >= 3 },
        { id: 10, name: 'Color Changer', description: 'Customize fish color.', achieved: false, condition: () => fishColorPalette !== 'default' },
        { id: 11, name: 'Food Variety', description: 'Use 4 different food types.', achieved: false, condition: () => ownedFish.reduce((set, fish) => { foodItems.filter(f => f.targetedByFishId === fish.id).forEach(food => set.add(food.type)); return set; }, new Set()).size >= 4 },
        { id: 12, name: 'Crate Opener', description: 'Open 3 food crates.', achieved: false, condition: () => crateOpenCount >= 3 },
        { id: 13, name: 'Background Artist', description: 'Change aquarium background.', achieved: false, condition: () => aquariumBackground !== 'default' },
        { id: 14, name: 'Combo Feeder', description: 'Reach a 3x food combo.', achieved: false, condition: () => maxComboReached >= 3 }
      ];

      let bubbleTimer, saveInterval, expansionsInterval, ambientDriftInterval, foodSpawnInterval, comboTimer;
      let achievementNotifications = 0;
      let lastUpdateTime = Date.now();
      let dailyRewardClaimed = false;
      let lastDailyRewardTime = null;
      let crateOpenCount = 0;
      let maxComboReached = 0;

      /* ======== LOADING & SAVING GAME ======== */
      const initializeDefaultData = () => {
        coins = 0; 
        fishColorPalette = 'default'; 
        aquariumBackground = 'default'; 
        ownedFish = [{ id: 1, x: 100, y: 100, direction: 'right', targetFoodId: null, foodEaten: 0, currentSpeed: fishTypes[0].baseSpeed, currentEarning: fishTypes[0].baseEarning, targetX: 300, targetY: 150 }];
        globalUpgrades.forEach(u => { u.purchased = false; }); 
        expansions.forEach(e => { e.purchasedCount = 0; }); 
        achievements.forEach(a => { a.achieved = false; });
        fishTypes.forEach(ft => { ft.upgrades.forEach(u => { u.purchasedCount = 0; }); }); 
        foodItems = []; 
        placedDecorations = []; 
        dailyRewardClaimed = false; 
        lastDailyRewardTime = null; 
        crateOpenCount = 0; 
        maxComboReached = 0;
      };

      const loadGame = () => {
        if (!localStorage.getItem('hasData')) { 
          initializeDefaultData(); 
          return; 
        }
        coins = parseFloat(localStorage.getItem('coins') || 0); 
        fishColorPalette = localStorage.getItem('fishColorPalette') || 'default'; 
        aquariumBackground = localStorage.getItem('aquariumBackground') || 'default';
        $('#aquarium').removeClass('bg-coral bg-ruins bg-cave').addClass(aquariumBackground);
        ownedFish = JSON.parse(localStorage.getItem('ownedFish') || '[]');
        ownedFish.forEach(f => { 
          const ft = fishTypes[f.id - 1]; 
          if (!ft) return; 
          const totalSpeedUp = ft.upgrades.find(u => u.id === `speed-${ft.id}`)?.purchasedCount || 0; 
          const totalEarningUp = ft.upgrades.find(u => u.id === `earning-${ft.id}`)?.purchasedCount || 0; 
          f.currentSpeed = ft.baseSpeed + totalSpeedUp; 
          f.currentEarning = ft.baseEarning + totalEarningUp; 
          if (typeof f.targetX === 'undefined') f.targetX = f.x; 
          if (typeof f.targetY === 'undefined') f.targetY = f.y; 
        });

        if (ownedFish.length === 0) { 
          const ft = fishTypes[0]; 
          ownedFish.push({ id: 1, x: 100, y: 100, direction: 'right', targetFoodId: null, foodEaten: 0, currentSpeed: ft.baseSpeed, currentEarning: ft.baseEarning, targetX: 300, targetY: 150 }); 
        }

        const purchasedGlobalUpg = JSON.parse(localStorage.getItem('globalUpgrades') || '[]');
        purchasedGlobalUpg.forEach(uId => { 
          const upg = globalUpgrades.find(u => u.id === uId); 
          if (upg && !upg.purchased) { 
            upg.purchased = true; 
            upg.effect(); 
          } 
        });

        const expansionsData = JSON.parse(localStorage.getItem('expansions') || '[]');
        expansionsData.forEach(e => { 
          const ex = expansions.find(x => x.id === e.id); 
          if (ex) ex.purchasedCount = e.purchasedCount; 
        });

        const achievedList = JSON.parse(localStorage.getItem('achievements') || '[]');
        achievedList.forEach(aId => { 
          const a = achievements.find(x => x.id === aId); 
          if (a) a.achieved = true; 
        });

        const fishUpgradesData = JSON.parse(localStorage.getItem('fishUpgrades') || '[]');
        fishUpgradesData.forEach(fu => { 
          const ft = fishTypes.find(x => x.id === fu.fishTypeId); 
          if (ft) { 
            fu.upgrades.forEach(up => { 
              const matchUp = ft.upgrades.find(m => m.id === up.id); 
              if (matchUp) { 
                matchUp.purchasedCount = up.purchasedCount; 
              } 
            }); 
          } 
        });

        placedDecorations = JSON.parse(localStorage.getItem('placedDecorations') || '[]');
        dailyRewardClaimed = localStorage.getItem('dailyRewardClaimed') === 'true';
        lastDailyRewardTime = localStorage.getItem('lastDailyRewardTime');
        crateOpenCount = parseInt(localStorage.getItem('crateOpenCount') || '0');
        maxComboReached = parseInt(localStorage.getItem('maxComboReached') || '0');

        foodTypes.forEach(ft => { // Load food upgrades
            const savedFoodUpgrade = localStorage.getItem(`foodUpgrade-${ft.type}`);
            if (savedFoodUpgrade) {
                ft.coinValue = parseFloat(savedFoodUpgrade); // For value upgrades
                if (ft.effectDuration) ft.effectDuration = parseFloat(savedFoodUpgrade); // For duration upgrades
            }
        });

        const savedLastUpdate = localStorage.getItem('lastUpdateTime');
        if (savedLastUpdate) { 
          const currentTime = Date.now(); 
          const elapsed = (currentTime - parseInt(savedLastUpdate)) / 1000;
          expansions.forEach(exp => { 
            if (exp.purchasedCount > 0) {
              if (exp.effectType === 'coins') { 
                let synergyMult = 1; 
                if (exp.synergy && exp.synergy > 0) { 
                  synergyMult += Math.floor(exp.purchasedCount / 10) * exp.synergy; 
                } 
                coins += exp.baseEffect * exp.purchasedCount * synergyMult * exp.effectRate * elapsed; 
              }
              else if (exp.effectType === 'food') { 
                const spawnRate = exp.baseEffect * exp.purchasedCount * exp.effectRate; 
                const totalFoods = Math.floor(spawnRate * elapsed); 
                for (let i = 0; i < totalFoods; i++) { 
                  spawnFood(); 
                } 
              } 
            }
          });
        }
        lastUpdateTime = parseInt(localStorage.getItem('lastUpdateTime')) || Date.now();
      };

      const saveGame = () => {
        localStorage.setItem('coins', coins); 
        localStorage.setItem('fishColorPalette', fishColorPalette); 
        localStorage.setItem('aquariumBackground', aquariumBackground); 
        localStorage.setItem('ownedFish', JSON.stringify(ownedFish));
        localStorage.setItem('globalUpgrades', JSON.stringify(globalUpgrades.filter(u => u.purchased).map(u => u.id)));
        localStorage.setItem('expansions', JSON.stringify(expansions.map(e => ({ id: e.id, purchasedCount: e.purchasedCount }))));
        localStorage.setItem('achievements', JSON.stringify(achievements.filter(a => a.achieved).map(a => a.id)));
        localStorage.setItem('fishUpgrades', JSON.stringify(fishTypes.map(ft => ({ fishTypeId: ft.id, upgrades: ft.upgrades.map(u => ({ id: u.id, purchasedCount: u.purchasedCount })) }))));
        localStorage.setItem('placedDecorations', JSON.stringify(placedDecorations));
        localStorage.setItem('dailyRewardClaimed', dailyRewardClaimed);
        localStorage.setItem('lastDailyRewardTime', lastDailyRewardTime);
        localStorage.setItem('crateOpenCount', crateOpenCount.toString());
        localStorage.setItem('maxComboReached', maxComboReached.toString());
        foodTypes.forEach(ft => { // Save food upgrades
            if (ft.type === 'basic' || ft.type === 'premium' || ft.type === 'gold') 
              localStorage.setItem(`foodUpgrade-${ft.type}`, ft.coinValue.toString()); // Save value upgrades
            if (ft.type === 'boost' || ft.type === 'growth' || ft.type === 'attract') 
              localStorage.setItem(`foodUpgrade-${ft.type}`, ft.effectDuration.toString()); // Save duration upgrades
        });
        localStorage.setItem('lastUpdateTime', Date.now()); 
        localStorage.setItem('hasData', 'true');
      };

      const resetAllData = () => {
        if (confirm('Are you sure you want to reset ALL progress? This cannot be undone.')) { 
          localStorage.clear(); 
          initializeDefaultData(); 
          renderFish(); 
          renderFoodItems(); 
          renderDecorations(); 
          updateCoinDisplay(); 
          showToast('Game reset!'); 
        }
      };

      /* ======== RENDER UI ======== */
      const updateCoinDisplay = () => { 
        $('#coin-count').text(Math.floor(coins)); 
        checkAchievements(); 
      };

      // ========== STORE UI ==========
      const showFishTooltip = (evt, fish) => {
        const tooltip = $('#fish-tooltip'); 
        let info = `<strong>${fish.name}</strong><br>Cost: ${Math.floor(fish.cost)}<br>Base Speed: ${fish.baseSpeed.toFixed(2)}<br>Base Earning: ${fish.baseEarning.toFixed(2)}<br><em>Upgrades Purchased:</em><br>`;
        fish.upgrades.forEach(up => { 
          info += `${up.name}: +${up.purchasedCount}<br>`; 
        }); 
        tooltip.html(info); 
        tooltip.css({ display: 'block', left: evt.pageX + 10 + 'px', top: evt.pageY + 'px' });
      };
      const hideFishTooltip = () => { $('#fish-tooltip').hide(); };

      const renderStore = () => {
        $('#store-items').empty(); 
        fishTypes.forEach(f => { 
          const ownedCount = ownedFish.filter(x => x.id === f.id).length;
          const row = $(`
            <div class="item-row fish-store-item" data-fid="${f.id}">
              <div style="position: relative;">
                <img src="${f.image}" alt="${f.name}">
                <span>${f.name} (Owned: ${ownedCount})</span>
              </div>
              <div>
                <button data-id="${f.id}">Buy (${Math.floor(f.cost)} coins)</button>
              </div>
            </div>
          `);
          $('#store-items').append(row); 
        });
      };

      // ========== GLOBAL UPGRADES UI ==========
      const renderGlobalUpgrades = () => {
        $('#upgrade-items').empty(); 
        globalUpgrades.forEach(u => { 
          const btnText = u.purchased ? 'Purchased' : `Buy (${Math.floor(u.cost)} coins)`; 
          const disabled = u.purchased ? 'disabled' : '';
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${u.name}</strong>
                <p>${u.description}</p>
              </div>
              <div>
                <button data-id="${u.id}" ${disabled}>${btnText}</button>
              </div>
            </div>
          `); 
          $('#upgrade-items').append(row); 
        });

        // Food Upgrades Section
        foodTypes.forEach(food => {
            const btnText = `Upgrade ${food.type.charAt(0).toUpperCase() + food.type.slice(1)} Food (+${food.upgradeIncrement} ${food.type === 'basic' || food.type === 'premium' || food.type === 'gold' ? 'coins' : 'seconds'})`;
            const row = $(`
              <div class="item-row">
                <div>
                  <strong>Upgrade ${food.type.charAt(0).toUpperCase() + food.type.slice(1)} Food</strong>
                  <p>Increases ${food.type} food value/effect.</p>
                  <p>Current Value: ${food.type === 'basic' || food.type === 'premium' || food.type === 'gold' ? Math.floor(food.coinValue) + ' coins' : food.effectDuration + ' seconds'}</p>
                </div>
                <div>
                  <button data-food-upgrade="${food.type}">${btnText}</button>
                </div>
              </div>
            `);
            $('#upgrade-items').append(row);
        });
      };

      // ========== EXPANSIONS UI ==========
      const renderExpansions = () => {
        $('#expansion-items').empty(); 
        expansions.forEach(e => { 
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${e.name}</strong>
                <p>${e.description}</p>
                <p>Owned: ${e.purchasedCount}</p>
              </div>
              <div>
                <button data-id="${e.id}">Buy (${Math.floor(e.cost)} coins)</button>
              </div>
            </div>
          `); 
          $('#expansion-items').append(row); 
        });
      };

      // ========== DECORATIONS UI ==========
      const renderDecorationsStore = () => {
        $('#decoration-items').empty(); 
        decorations.forEach(dec => {
            const thumbnail = dec.thumbClass ? `${dec.thumbClass}.png` : `${dec.type}_1.png`;
            const row = $(`
              <div class="item-row">
                <div>
                  <strong>${dec.name}</strong>
                  <img src="${thumbnail}" alt="${dec.name}">
                </div>
                <div>
                  <button data-decoration-id="${dec.id}">Buy (${Math.floor(dec.cost)} coins)</button>
                </div>
              </div>
            `); 
            $('#decoration-items').append(row);
        });
      };

      // ========== CUSTOMIZE UI ==========
      const renderCustomizeOptions = () => {
        const paletteContainer = $('#customize-items').find('#color-palettes'); 
        paletteContainer.empty();
        Object.keys(colorPalettes).forEach(paletteName => { 
          const paletteDiv = $(`
            <div>
              <strong>${paletteName.toUpperCase()}</strong>
              <div class="color-palette" data-palette="${paletteName}"></div>
            </div>
          `); 
          paletteContainer.append(paletteDiv); 
          const colors = colorPalettes[paletteName]; 
          const colorPaletteDiv = paletteDiv.find('.color-palette');
          colors.forEach(color => { 
            const swatch = $('<div class="color-swatch"></div>'); 
            swatch.css('background-color', color); 
            colorPaletteDiv.append(swatch); 
          });
          const defaultSwatch = $('<div class="color-swatch"></div>'); 
          colorPaletteDiv.prepend(defaultSwatch); 
          if (paletteName === 'default') defaultSwatch.addClass('selected');
        });
      };

      // ========== ACHIEVEMENTS UI ==========
      const renderAchievements = () => {
        $('#achievement-items').empty(); 
        achievements.forEach(a => { 
          const status = a.achieved ? '<span class="badge bg-success">Achieved</span>' : '<span class="badge bg-secondary">Locked</span>';
          const row = $(`
            <div class="item-row">
              <div>
                <strong>${a.name}</strong>
                <p>${a.description}</p>
              </div>
              <div>${status}</div>
            </div>
          `); 
          $('#achievement-items').append(row); 
        });
      };

      // ========== DAILY REWARD UI ==========
      const updateDailyRewardUI = () => {
        const rewardButton = $('.daily-reward-button'); 
        const claimButton = $('#claim-daily-reward'); 
        const statusDisplay = $('#daily-reward-status');
        if (dailyRewardClaimed) { 
          rewardButton.addClass('claimed'); 
          claimButton.prop('disabled', true); 
          statusDisplay.text('Reward claimed today!'); 
        }
        else { 
          rewardButton.removeClass('claimed'); 
          claimButton.prop('disabled', false); 
          statusDisplay.text(''); 
        }
      };

      const checkDailyRewardAvailability = () => {
        if (!lastDailyRewardTime) { 
          dailyRewardClaimed = false; 
          updateDailyRewardUI(); 
          return; 
        }
        const lastClaimDate = new Date(parseInt(lastDailyRewardTime)); 
        const today = new Date();
        if (lastClaimDate.toDateString() === today.toDateString()) { 
          dailyRewardClaimed = true; 
        } else { 
          dailyRewardClaimed = false; 
        } 
        updateDailyRewardUI();
      };

      // ========== FOOD CRATES UI ==========
      const showCratePurchaseStatus = (message) => {
          $('#crate-purchase-status').text(message).fadeIn().delay(3000).fadeOut();
      };

      /* ======== FISH & FOOD RENDERING/LOGIC ======== */
      const renderFish = () => {
        $('#aquarium .fish').remove(); 
        ownedFish.forEach((f, index) => { 
          const ft = fishTypes[f.id - 1];
          const fishDiv = $(`<div class="fish" data-index="${index}"></div>`); 
          fishDiv.css({ 
            left: f.x + 'px', 
            top: f.y + 'px', 
            backgroundImage: `url(${ft.image})`, 
            transform: f.direction === 'left' ? 'scaleX(-1)' : 'scaleX(1)', 
            filter: colorPalettes[fishColorPalette].join(' ') 
          });
          $('#aquarium').append(fishDiv); 
        });
      };

      const renderFoodItems = () => {
        $('#aquarium .food').remove(); 
        foodItems.forEach(food => { 
          const fd = $('<div class="food"></div>'); 
          fd.attr('data-id', food.id).addClass(food.effect === 'speedBoost' ? 'food-boost' : (food.effect === 'growthBoost' ? 'food-growth' : (food.effect === 'attractFish' ? 'food-attract' : ''))); 
          fd.css({ 
            left: food.x + 'px', 
            top: food.y + 'px', 
            backgroundColor: food.color 
          });
          if (food.effect) { 
            fd.append(`<div class="food-effect-text">${food.effect.replace('Boost', '+Speed').replace('Fish', '')}</div>`); 
          } 
          $('#aquarium').append(fd); 
        });
      };

      const renderDecorations = () => {
        $('#aquarium .decoration').remove();
        placedDecorations.forEach(dec => {
            if (dec.type === 'background') {
                $('#aquarium').removeClass('bg-coral bg-ruins bg-cave').addClass(dec.bgClass);
            } else {
                const decDiv = $(`<div class="decoration ${dec.type}"></div>`); 
                decDiv.css({ left: dec.x + 'px', top: dec.y + 'px' }); 
                $('#aquarium').append(decDiv);
            }
        });
      };

      function isOverlap(el1, el2) {
        const rect1 = el1.offset(); 
        rect1.right = rect1.left + el1.outerWidth(true); 
        rect1.bottom = rect1.top + el1.outerHeight(true);
        const rect2 = el2.offset(); 
        rect2.right = rect2.left + el2.outerWidth(true); 
        rect2.bottom = rect2.top + el2.outerHeight(true);
        return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
      }

      function assignCoinsToFish() {
        ownedFish.forEach(f => { f.targetFoodId = null; }); 
        let pairs = [];
        ownedFish.forEach(fish => { 
          foodItems.forEach(coin => { 
            if (coin.dropComplete && Math.abs(coin.y - coin.finalY) <= FOOD_DETECT_RANGE_Y) {
              const dx = coin.x - fish.x; 
              const dy = coin.y - fish.y; 
              const dist = Math.hypot(dx, dy); 
              pairs.push({ fish, coin, dist }); 
            } 
          }); 
        });
        pairs.sort((a, b) => a.dist - b.dist); 
        const assignedFish = new Set(); 
        const assignedCoins = new Set();
        pairs.forEach(pair => { 
          if (!assignedFish.has(pair.fish) && !assignedCoins.has(pair.coin.id)) {
            pair.fish.targetFoodId = pair.coin.id; 
            pair.fish.targetX = pair.coin.x; 
            pair.fish.targetY = pair.coin.y; 
            assignedFish.add(pair.fish); 
            assignedCoins.add(pair.coin.id); 
          } 
        });
      }

      const moveFish = (dt) => {
        assignCoinsToFish(); 
        ownedFish.forEach((fish, index) => { 
          const targetFood = foodItems.find(fd => fd.id === fish.targetFoodId);
          const fishDiv = $(`.fish[data-index="${index}"]`);
          if (targetFood) { 
            const foodDiv = $(`.food[data-id="${targetFood.id}"]`); 
            if (isOverlap(fishDiv, foodDiv)) {
              const earning = fish.currentEarning || 1; 
              let totalCoins = earning * targetFood.coinValue * comboMultiplier; 
              coins += totalCoins; 
              updateCoinDisplay();
              fish.foodEaten++; 
              createFloatingText(targetFood.x, targetFood.y, `+${Math.floor(totalCoins)}`); 
              foodItems = foodItems.filter(fd => fd.id !== targetFood.id);
              fish.targetFoodId = null; 
              setRandomDriftTarget(fish); 
              lastFoodDropTime = 0; 
              comboMultiplier = 1; 
              clearTimeout(comboTimer);

              // Apply food effect
              if (targetFood.effect === 'speedBoost') { 
                applySpeedBoost(fish, targetFood.effectDuration); 
              }
              else if (targetFood.effect === 'growthBoost') { 
                applyGrowthBoost(fish, targetFood.effectDuration); 
              } 
              return; 
            }
            const dx = targetFood.x - fish.x; 
            const dy = targetFood.y - fish.y; 
            const dist = Math.hypot(dx, dy); 
            fish.direction = dx < 0 ? 'left' : 'right';
            const speed = fish.currentSpeed || 1.0; 
            const moveX = (dx / dist) * speed; 
            const moveY = (dy / dist) * speed; 
            fish.x += moveX; 
            fish.y += moveY;
          } else { 
            if (fish.targetFoodId === null) { 
              const dxDrift = fish.targetX - fish.x; 
              const dyDrift = fish.targetY - fish.y; 
              const distDrift = Math.hypot(dxDrift, dyDrift);
              if (distDrift > 1) { 
                fish.direction = dxDrift < 0 ? 'left' : 'right'; 
                const driftSpeed = 0.2; 
                fish.x += (dxDrift / distDrift) * driftSpeed; 
                fish.y += (dyDrift / distDrift) * driftSpeed; 
              } 
            } 
          }
          const fishW = 96; 
          const fishH = 64; 
          const winW = $(window).width(); 
          const winH = $(window).height();
          fish.x = Math.max(0, Math.min(winW - fishW, fish.x)); 
          fish.y = Math.max(0, Math.min(winH - fishH, fish.y));
          fishDiv.css({ 
            left: fish.x + 'px', 
            top: fish.y + 'px', 
            transform: fish.direction === 'left' ? 'scaleX(-1)' : 'scaleX(1)' 
          });
        });

        // Attraction food effect - move all fish towards attract food
        foodItems.filter(food => food.effect === 'attractFish' && food.dropComplete).forEach(attractFood => {
            ownedFish.forEach(fish => {
                if (!fish.targetFoodId) { // Only target fish not already going for food
                    fish.targetX = attractFood.x;
                    fish.targetY = attractFood.y;
                }
            });
        });
      };

      // Apply speed boost effect to fish
      function applySpeedBoost(fish, duration) {
        fish.currentSpeed *= 2; 
        showToast(`${fishTypes[fish.id-1].name} speed boosted!`);
        setTimeout(() => { 
          fish.currentSpeed /= 2; 
        }, duration * 1000);
      }

      // Apply growth boost effect to fish
      function applyGrowthBoost(fish, duration) {
        fish.currentEarning *= 1.5; 
        showToast(`${fishTypes[fish.id-1].name} earning boosted!`); 
        setTimeout(() => { 
          fish.currentEarning /= 1.5; 
        }, duration * 1000);
      }

      function setRandomDriftTarget(fish) {
        const winW = $(window).width(); 
        const winH = $(window).height(); 
        const fishW = 96; 
        const fishH = 64;
        fish.targetX = Math.random() * (winW - fishW - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN; 
        fish.targetY = Math.random() * (winH - fishH - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN;
      }

      /* FOOD DROPPING */
      const spawnFood = () => {
        const pick = Math.random(); 
        let chosen;
        if (pick < 0.5) chosen = foodTypes[0]; // Basic
        else if (pick < 0.75) chosen = foodTypes[1]; // Premium
        else if (pick < 0.85) chosen = foodTypes[2]; // Gold
        else if (pick < 0.93) chosen = foodTypes[3]; // Boost food
        else if (pick < 0.97) chosen = foodTypes[4]; // Growth food
        else chosen = foodTypes[5];                  // Attract food (rarest)

        const winW = $(window).width(); 
        const winH = $(window).height(); 
        const spawnX = Math.random() * (winW - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN;
        const minFinalY = Math.max(winH * 0.4, COIN_SPAWN_MARGIN); 
        const maxFinalY = Math.min(winH * 0.8, winH - COIN_SPAWN_MARGIN); 
        const chosenFinalY = Math.random() * (maxFinalY - minFinalY) + minFinalY;
        const fObj = { 
          id: Date.now() + Math.random(), 
          x: spawnX, 
          y: COIN_SPAWN_MARGIN / 2, 
          finalY: chosenFinalY, 
          dropComplete: false, 
          hoverPhase: 0, 
          coinValue: chosen.coinValue, 
          color: chosen.color, 
          targetedByFishId: null, 
          effect: chosen.effect, 
          effectDuration: chosen.effectDuration, 
          type: chosen.type 
        }; 
        foodItems.push(fObj);

        // Combo system check on food drop
        const currentTime = Date.now();
        if (currentTime - lastFoodDropTime <= FOOD_COMBO_WINDOW) {
            comboMultiplier += 0.25; // Increase combo multiplier
            if (comboMultiplier > maxComboReached) maxComboReached = comboMultiplier; // Track max combo
            showToast(`Food Combo! x${comboMultiplier.toFixed(2)} Coins!`);
            clearTimeout(comboTimer); // Reset timer on each drop in combo window
        }
        lastFoodDropTime = currentTime;
        comboTimer = setTimeout(() => { 
          comboMultiplier = 1; 
        }, FOOD_COMBO_WINDOW + 1000); // slightly longer than window to reset after
      };

      const moveFood = () => {
        foodItems.forEach(food => { 
          if (!food.dropComplete) { 
            const dropSpeed = 1.5; 
            if (food.y < food.finalY) { 
              food.y += dropSpeed; 
              if (food.y >= food.finalY) { 
                food.y = food.finalY; 
                food.dropComplete = true; 
              } 
            } 
          }
          else { 
            food.hoverPhase += 0.04; 
            const amplitude = 5; 
            const offsetY = amplitude * Math.sin(food.hoverPhase); 
            food.y = food.finalY + offsetY; 
          } 
        });

        // Auto-collect coins from missed food if upgrade purchased
        if (globalUpgrades.find(u => u.id === 9 && u.purchased)) { // Upgrade ID 9 is Auto-Collect Food
            foodItems.forEach(food => {
                if (food.dropComplete && !food.collected && food.y > $(window).height() + 50) { // Check if food is off-screen and not yet collected
                    coins += food.coinValue * 0.1; // Collect 10% coin value
                    food.collected = true; // Mark as collected to avoid repeat collection
                    updateCoinDisplay();
                    createFloatingText(food.x, food.y, `+${Math.floor(food.coinValue * 0.1)} (Auto-Collect)`);
                }
            });
            foodItems = foodItems.filter(food => !food.collected); // Remove collected food items
        }
      };

      const createFloatingText = (x, y, text) => {
        const ft = $(`<div class="floating-text">${text}</div>`); 
        ft.css({ left: x + 'px', top: y + 'px' }); 
        $('#aquarium').append(ft); 
        setTimeout(() => { 
          ft.remove(); 
        }, 2000);
      };

      /* ======== EXPANSIONS ======== */
      const runExpansions = () => {
        expansions.forEach(exp => { 
          if (exp.purchasedCount > 0) {
            if (exp.effectType === 'coins') { 
              let synergyMult = 1; 
              if (exp.synergy && exp.synergy > 0) { 
                synergyMult += Math.floor(exp.purchasedCount / 10) * exp.synergy; 
              } 
              coins += exp.baseEffect * exp.purchasedCount * synergyMult * exp.effectRate; 
            }
            else if (exp.effectType === 'food') { 
              let spawnRate = exp.baseEffect * exp.purchasedCount * exp.effectRate; 
              const integerSpawn = Math.floor(spawnRate); 
              for (let i = 0; i < integerSpawn; i++) { 
                spawnFood(); 
              } 
            } 
          } 
        });
        updateCoinDisplay();
      };

      /* ======== ACHIEVEMENTS ======== */
      const checkAchievements = () => {
        achievements.forEach(a => { 
          if (!a.achieved && a.condition()) { 
            a.achieved = true; 
            achievementNotifications++; 
            showToast(`Achievement Unlocked: ${a.name}`); 
          } 
        });
        if (achievementNotifications > 0) { 
          $('.achievements-button').addClass('has-new-achievements'); 
          $('.achievements-button').attr('data-badge', achievementNotifications); 
        }
      };

      // Toast message function
      let toastCounter = 0; 
      const showToast = (message) => {
        const toastId = `toast-${toastCounter++}`; 
        const toast = $(`<div class="toast-message" id="${toastId}">${message}</div>`); 
        $('#toast-container').append(toast); 
        setTimeout(() => { 
          $(`#${toastId}`).remove(); 
        }, 3000);
      };

      /* ======== BUBBLES ======== */
      const spawnBubble = () => {
        const bubble = $('<div class="bubble"></div>'); 
        const startX = Math.random() * ($(window).width() - 15); 
        bubble.css({ left: startX + 'px', bottom: '0px' }); 
        $('#aquarium').append(bubble); 
        setTimeout(() => { 
          bubble.remove(); 
        }, 5000);
      };

      /* ======== EVENT HANDLERS ======== */
      const openModal = sel => { $(sel).fadeIn(); }; 
      const closeModal = sel => { $(sel).fadeOut(); };

      $('.nav-link, .dropdown-item').click(function(e) {
        const action = $(this).text().trim();
        if (action === 'Fish Store') { renderStore(); openModal('.store-modal'); }
        else if (action === 'Global Upgrades') { renderGlobalUpgrades(); openModal('.upgrades-modal'); }
        else if (action === 'Expansions') { renderExpansions(); openModal('.expansions-modal'); }
        else if (action === 'Decorations') { renderDecorationsStore(); openModal('.decorations-modal'); }
        else if (action === 'Customize') { renderCustomizeOptions(); openModal('.customize-modal'); }
        else if (action === 'Achievements') { renderAchievements(); openModal('.achievements-modal'); achievementNotifications = 0; $('.achievements-button').removeClass('has-new-achievements'); $('.achievements-button').attr('data-badge', 0); }
        else if (action === 'Food Crates') { openModal('.crates-modal'); }
        else if (action === 'Reset All') { resetAllData(); }
        e.stopPropagation();
      });

      $('.close-modal').click(function() { closeModal($(this).closest('.modal-overlay')); });

      $(document).on('click', function(event) { 
        if (!$(event.target).closest('.modal-content').length && $('.modal-overlay:visible').length) { 
          $('.modal-overlay:visible').fadeOut(); 
        } 
      });

      // Hover tooltip for fish stats
      $('#store-items').on('mouseenter', '.fish-store-item', function(e) { 
        const fid = parseInt($(this).data('fid')); 
        const fish = fishTypes.find(x => x.id === fid); 
        showFishTooltip(e, fish); 
      }).on('mousemove', '.fish-store-item', function(e) { 
        const fid = parseInt($(this).data('fid')); 
        const fish = fishTypes.find(x => x.id === fid); 
        showFishTooltip(e, fish); 
      }).on('mouseleave', '.fish-store-item', function() { 
        hideFishTooltip(); 
      });

      // Store -> Buy Fish
      $('#store-items').on('click', 'button', function() { 
        const fishId = parseInt($(this).data('id')); 
        const ft = fishTypes.find(f => f.id === fishId); 
        if (!ft) return;
        if (coins >= ft.cost) { 
          coins -= ft.cost; 
          updateCoinDisplay(); 
          const totalSpeedUp = ft.upgrades.find(u => u.id === `speed-${ft.id}`)?.purchasedCount || 0; 
          const totalEarningUp = ft.upgrades.find(u => u.id === `earning-${ft.id}`)?.purchasedCount || 0;
          const newFish = { 
            id: ft.id, 
            x: Math.random() * ($(window).width() - 96), 
            y: Math.random() * ($(window).height() - 64), 
            direction: 'right', 
            targetFoodId: null, 
            foodEaten: 0, 
            currentSpeed: ft.baseSpeed + totalSpeedUp, 
            currentEarning: ft.baseEarning + totalEarningUp, 
            targetX:  Math.random() * ($(window).width() - 96), 
            targetY: Math.random() * ($(window).height() - 64) 
          };
          ownedFish.push(newFish); 
          renderFish(); 
          checkAchievements(); 
        } else { 
          showToast('Not enough coins!'); 
        } 
      });

      // Buy Global Upgrades
      $('#upgrade-items').on('click', 'button', function() { 
        const upgId = parseInt($(this).data('id')); 
        const upg = globalUpgrades.find(u => u.id === upgId); 
        if (!upg || upg.purchased) return;
        if (coins >= upg.cost) { 
          coins -= upg.cost; 
          upg.purchased = true; 
          upg.effect(); 
          updateCoinDisplay(); 
          renderGlobalUpgrades(); 
          showToast(`Upgrade Purchased: ${upg.name}`); 
        } else { 
          showToast('Not enough coins!'); 
        } 
      });

      // Upgrade Food Value/Effect
      $('#upgrade-items').on('click', 'button[data-food-upgrade]', function() {
          const foodType = $(this).data('food-upgrade'); 
          const food = foodTypes.find(f => f.type === foodType); 
          if (!food) return;
          if (coins >= food.upgradeCost) { 
              coins -= food.upgradeCost; 
              updateCoinDisplay();
              if (food.type === 'basic' || food.type === 'premium' || food.type === 'gold') 
                food.coinValue += food.upgradeIncrement; // Increase value
              if (food.effectDuration) 
                food.effectDuration += food.upgradeIncrement; // Increase duration
              renderGlobalUpgrades(); 
              showToast(`${food.type.charAt(0).toUpperCase() + food.type.slice(1)} Food Upgraded!`); 
              saveGame(); 
          } else { 
            showToast('Not enough coins!'); 
          }
      });

      // Buy Expansions
      $('#expansion-items').on('click', 'button', function() { 
        const expId = parseInt($(this).data('id')); 
        const ex = expansions.find(e => e.id === expId); 
        if (!ex) return;
        if (coins >= ex.cost) { 
          coins -= ex.cost; 
          ex.purchasedCount++; 
          updateCoinDisplay(); 
          renderExpansions(); 
          checkAchievements(); 
          showToast(`Expansion Purchased: ${ex.name}`); 
        } else { 
          showToast('Not enough coins!'); 
        } 
      });

      // Buy Decorations
      $('#decoration-items').on('click', 'button', function() { 
        const decId = parseInt($(this).data('decoration-id')); 
        const dec = decorations.find(d => d.id === decId); 
        if (!dec) return;
        if (coins >= dec.cost) { 
          coins -= dec.cost; 
          updateCoinDisplay(); 
          openModal('.decorations-modal'); 
          showToast(`${dec.name} purchased! Click in aquarium to place.`);
          $('#aquarium').one('click', function(e) { 
            const aquariumOffset = $('#aquarium').offset(); 
            const placeX = e.pageX - aquariumOffset.left - (dec.type === 'background' ? 0 : 32); 
            const placeY = e.pageY - aquariumOffset.top - (dec.type === 'background' ? 0 : 32); 
            placedDecorations.push({ 
              type: dec.type, 
              x: placeX, 
              y: placeY, 
              bgClass: dec.bgClass 
            }); 
            renderDecorations(); 
            checkAchievements(); 
            $('#aquarium').off('click'); 
          });
        } else { 
          showToast('Not enough coins!'); 
        } 
      });

      // Customize Fish Color Palette
      $('#customize-items').on('click', '.color-swatch', function() { 
        $('.color-swatch').removeClass('selected'); 
        $(this).addClass('selected'); 
        const paletteName = $(this).parent('.color-palette').data('palette'); 
        fishColorPalette = paletteName; 
        renderFish(); 
        checkAchievements(); 
        showToast(`Color palette changed to ${paletteName.toUpperCase()}!`); 
      });

      // Claim Daily Reward
      $('#claim-daily-reward').click(() => { 
        if (!dailyRewardClaimed) { 
          coins += DAILY_REWARD_COINS; 
          dailyRewardClaimed = true; 
          lastDailyRewardTime = Date.now().toString(); 
          saveGame(); 
          updateCoinDisplay(); 
          updateDailyRewardUI(); 
          showToast(`Daily reward claimed: ${DAILY_REWARD_COINS} coins!`); 
        } 
      });

      // Buy Food Crates
      $('#crates-items').on('click', 'button', function() {
          const crateType = $(this).data('crate-type'); 
          let crateCost, foodRewardTypes;

          if (crateType === 'basic') { 
            crateCost = 150; 
            foodRewardTypes = ['basic', 'premium']; 
          }
          else if (crateType === 'premium') { 
            crateCost = 500; 
            foodRewardTypes = ['premium', 'gold', 'boost']; 
          }

          if (coins >= crateCost) {
              coins -= crateCost; 
              updateCoinDisplay(); 
              crateOpenCount++; 
              checkAchievements(); 
              saveGame();

              let foodTypeAwarded;
              if (crateType === 'basic') 
                foodTypeAwarded = foodRewardTypes[Math.floor(Math.random() * foodRewardTypes.length)]; // Random basic/premium
              else 
                foodTypeAwarded = foodRewardTypes[Math.floor(Math.random() * foodRewardTypes.length)]; // Random premium/gold/boost

              spawnCrateFood(foodTypeAwarded); // Spawn food from crate
              showCratePurchaseStatus(`Crate opened! Awarded ${foodTypeAwarded} food.`);
          } else { 
            showCratePurchaseStatus('Not enough coins!'); 
          }
      });

      // Function to spawn food from crates
      function spawnCrateFood(foodTypeAwarded) {
          const chosenFood = foodTypes.find(f => f.type === foodTypeAwarded);
          if (!chosenFood) return;

          const winW = $(window).width(); 
          const winH = $(window).height(); 
          const spawnX = Math.random() * (winW - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN;
          const minFinalY = Math.max(winH * 0.4, COIN_SPAWN_MARGIN); 
          const maxFinalY = Math.min(winH * 0.8, winH - COIN_SPAWN_MARGIN); 
          const chosenFinalY = Math.random() * (maxFinalY - minFinalY) + minFinalY;
          const fObj = { 
            id: Date.now() + Math.random(), 
            x: spawnX, 
            y: COIN_SPAWN_MARGIN / 2, 
            finalY: chosenFinalY, 
            dropComplete: false, 
            hoverPhase: 0, 
            coinValue: chosenFood.coinValue, 
            color: chosenFood.color, 
            targetedByFishId: null, 
            effect: chosenFood.effect, 
            effectDuration: chosenFood.effectDuration, 
            type: chosenFood.type 
          };
          foodItems.push(fObj);
      }

      // Spacebar -> Drop manual basic food
      $(document).keydown(e => { 
        if (e.code === 'Space') { 
          e.preventDefault(); 
          spawnManualFood(); 
        } 
      }); 
      const spawnManualFood = () => { 
        const chosen = foodTypes[0]; 
        const spawnX = Math.random() * ($(window).width() - COIN_SPAWN_MARGIN * 2) + COIN_SPAWN_MARGIN; 
        const winH = $(window).height(); 
        const minFinalY = Math.max(winH * 0.4, COIN_SPAWN_MARGIN); 
        const maxFinalY = Math.min(winH * 0.8, winH - COIN_SPAWN_MARGIN); 
        const chosenFinalY = Math.random() * (maxFinalY - minFinalY) + minFinalY; 
        const fObj = { 
          id: Date.now() + Math.random(), 
          x: spawnX, 
          y: COIN_SPAWN_MARGIN / 2, 
          finalY: chosenFinalY, 
          dropComplete: false, 
          hoverPhase: 0, 
          coinValue: chosen.coinValue, 
          color: chosen.color, 
          targetedByFishId: null, 
          effect: chosen.effect, 
          effectDuration: chosen.effectDuration, 
          type: chosen.type 
        }; 
        foodItems.push(fObj); 
      };

      /* ======== MAIN GAME LOOP ======== */
      let lastFrameTime = performance.now(); 
      const gameLoop = (now) => { 
        const dt = (now - lastFrameTime) / 1000; 
        lastFrameTime = now; 
        moveFish(dt); 
        moveFood(); 
        renderFoodItems(); 
        renderFish(); 
        requestAnimationFrame(gameLoop); 
      };

      /* ======== INIT & START ======== */
      loadGame(); 
      renderFish(); 
      renderFoodItems(); 
      renderDecorations(); 
      updateCoinDisplay(); 
      ownedFish.forEach(fish => setRandomDriftTarget(fish)); 
      checkDailyRewardAvailability(); 
      updateDailyRewardUI();
      requestAnimationFrame((t) => { 
        lastFrameTime = t; 
        gameLoop(t); 
      }); 
      foodSpawnInterval = setInterval(spawnFood, 4000); 
      expansionsInterval = setInterval(runExpansions, 1000); 
      bubbleTimer = setInterval(spawnBubble, 2000); 
      saveInterval = setInterval(saveGame, 15000); 
      ambientDriftInterval = setInterval(() => { 
        ownedFish.forEach(fish => setRandomDriftTarget(fish)); 
      }, 5000);
      $(window).on('beforeunload', () => { 
        saveGame(); 
      });
    });
  </script>
</body>
</html>
